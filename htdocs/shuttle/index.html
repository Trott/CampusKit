<!-- 
    TODO: move controller code to its own file, duh
    TODO: tests, duh
    TODO: move controller to its own file, duh
-->
<!DOCTYPE html>
<html data-ng-app="shuttle">
<head>
    <meta charset="utf-8">
    <title>UCSF Mobile | Shuttle</title>
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" media="screen">
    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" href="/assets/css/ie.css" media="screen">
        <![endif]-->
        <link rel="stylesheet" type="text/css" href="/assets/css/secondary.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/assets/css/shuttle.css" media="screen">
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">

        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png">
    </head>
    <body>
        <header class="header"><a href="/"><div class="logo"></div><span>Mobile</span></a><img src="/assets/img/ucsf-header-separator.png" alt=" | " class="separator"><span><a href="/shuttle">Shuttle</a></span></header>

        <div ng-view></div>

        <footer><p>University of California &copy; 2010-12 UC Regents<br><a href="/about">About</a> | <a href="/feedback/">Feedback</a></p></footer>
        <script src="/assets/js/ucsf.js"></script>
        <script src="/assets/js/angular.js"></script>
        <!--    <script src="/assets/js/shuttle.js"></script> -->
        <script>
        angular.module('shuttle', []).
            config(['$routeProvider', function($routeProvider) {
                $routeProvider.
                    when('/', {templateUrl: 'partials/main_menu.html'}).
                    when('/planner', {templateUrl: 'partials/planner.html', controller: 'planController'}).
                    when('/planner/:fromPlace/:toPlace/:when/:time/:date', {templateUrl: 'partials/planner.html', controller: 'planController'}).
                    otherwise({redirectTo: '/'});
            }]).
            controller({
            planController: function ($scope, $filter, $http, $location, $routeParams) {
                var apikey = 'c631ef46e918c82cf81ef4869f0029d4'

                if ($routeParams.fromPlace && $routeParams.toPlace && $routeParams.when && $routeParams.time && $routeParams.date) {
                    var planXhrParams = {
                        apikey: apikey,
                        fromPlace: $routeParams.fromPlace,
                        toPlace: $routeParams.toPlace                        
                    }

                    $scope.when = $routeParams.when;
                    $scope.time = $routeParams.time;
                    $scope.date = $routeParams.date;

                    if ($routeParams.when !== "now") {
                        planXhrParams.arriveBy = $routeParams.when==="arrive";
                        planXhrParams.time = $routeParams.time;
                        var date = new Date();
                        date.setDate(date.getDate() + parseInt($routeParams.date,10));
                        planXhrParams.date = $filter('date')(date , 'M/d/yyyy');
                    }

                    $scope.isLoading = true;
                    
                    var planXhr = $http({
                        method: 'GET', 
                        url: 'http://apis.ucsf.edu/shuttle/plan',
                        params: planXhrParams
                    }).success(function (data) {
                        $scope.isLoading = false;
                        $scope.planLoaded = true;
                        var plan = data.plan || {};
                        if (plan.itineraries) {
                            // Used to check that the plan is within four hours of the target time.
                            var datestamp = plan.date ? plan.date : Date.now();
                            var fourHours = 4 * 60 * 60 * 1000;
                            var index=1;
                            var itinerariesCount = plan.itineraries.length;
                            var removalQueue = [];
                            var massagedLeg;
                            var tripSteps;
                            // Decrement with while rather than increment with for so that splice() doesn't mess up the loop
                            for (var i=0; i<itinerariesCount; i++) {
                                // Only use itineraries that are less than 2 hours (e.g., not overnight)
                                // This check should probably be happening on the server side.
                                // Then check that the time is within four hours of what was chosen
                                // so the user doesn't get a trip for the next day.
                                if ((plan.itineraries[i].duration < 2 * 60 * 60 * 1000) &&
                                    (plan.itineraries[i].endTime >= datestamp - fourHours) &&
                                    (plan.itineraries[i].endTime <= datestamp + fourHours)) {
                                    plan.itineraries[i].index = index;
                                    index++;
                                    plan.itineraries[i].startTimeFormatted = $filter('date')(plan.itineraries[i].startTime, 'shortTime');
                                    plan.itineraries[i].endTimeFormatted = $filter('date')(plan.itineraries[i].endTime, 'shortTime');
                                    plan.itineraries[i].durationFormatted = Math.round(plan.itineraries[i].duration / (60 * 1000));
                                    if (plan.itineraries[i].hasOwnProperty('legs')) {
                                        tripSteps = plan.itineraries[i].legs.length;
                                        for (var j=0; j<tripSteps; j++) {
                                            massagedLeg = {};
                                            massagedLeg.toName = plan.itineraries[i].legs[j].to.name;

                                            if (plan.itineraries[i].legs[j].mode === "BUS") {
                                                massagedLeg.fromName = plan.itineraries[i].legs[j].from.name;
                                                massagedLeg.route = plan.itineraries[i].legs[j].route;
                                                massagedLeg.routeId = plan.itineraries[i].legs[j].routeId;
                                                massagedLeg.startTime = $filter('date')(plan.itineraries[i].legs[j].startTime, 'shortTime');
                                                massagedLeg.endTime = $filter('date')(plan.itineraries[i].legs[j].endTime, 'shortTime');
                                                plan.itineraries[i].legs[j].bus = massagedLeg;
                                            }

                                            if (plan.itineraries[i].legs[j].mode === "WALK") {
                                                plan.itineraries[i].legs[j].walk = massagedLeg;
                                            }
                                        }
                                    }
                                } else {
                                    removalQueue.push(i);
                                }
                            }
                            // Start from end so splice() doesn't mess up
                            i = removalQueue.length;
                            while (i--) {
                                plan.itineraries.splice(removalQueue[i],1);
                            }
                            $scope.itineraries = plan.itineraries;
                        }
                        //TODO: resultsElement.scrollIntoView();
                    }).error(function () {
                        //TODO: uh, yeah, this
                        console.dir('oh noes!');
                    });
                }

                if (! $scope.time) {
                    var now = Date.now(),
                        minutes = Math.floor(parseInt($filter('date')(now, 'mm'), 10) / 15) * 15;
                    if (minutes == 0) {
                        minutes = "00";
                    }
                    $scope.time = $filter('date')(now, 'h:' + minutes + ' a');
                }
                $scope.when = $scope.when || 'now';
                $scope.date = $scope.date || 0;

                $scope.isLoading = true;
                $scope.stopsLoadError = false;
                $scope.stopsLoaded = false;
                $scope.planLoaded = false;
                $scope.planLoadError = false;

                var xhr = $http({
                    method: 'GET', 
                    url: 'http://apis.ucsf.edu/shuttle/stops',
                    params: {apikey: apikey}
                }).success(function (data) {
                    $scope.isLoading = false;
                    if (data.stops) {
                        $scope.stops = $filter('orderBy')(data.stops, 'stopName');

                        $scope.begin = $filter('filter')($scope.stops, 
                            function (elem) {
                                return elem.stopName == 'Parnassus Campus';
                            }
                        )[0];
                        $scope.end = $filter('filter')($scope.stops, 
                            function (elem) {
                                return elem.stopName == 'Mission Bay Campus';
                            }
                        )[0];
                        if (Modernizr.localstorage) {
                            if (localStorage.shuttle_start) {
                                $scope.begin = $scope.stops[localStorage.shuttle_start] || $scope.begin;
                            } 
                            if (localStorage.shuttle_end) {
                                $scope.end = $scope.stops[localStorage.shuttle_end] || $scope.end;
                            }
                        }
                        $scope.stopsLoaded = true;
                    } else {
                        $scope.stopsLoadError = true;
                    }
                }).error(function () {
                    $scope.isLoading = false;
                    $scope.stopsLoadError = true;
                });

                $scope.plan = function () {
                    var fromPlace = $scope.begin.id.agencyId + '_' + $scope.begin.id.id,
                        toPlace = $scope.end.id.agencyId + '_' + $scope.end.id.id;

                    if(Modernizr.localstorage) {
                        localStorage.shuttle_start = $scope.stops.indexOf($scope.begin);
                        localStorage.shuttle_end = $scope.stops.indexOf($scope.end);
                    }
                    
                    $location.url('/planner/' + [fromPlace, toPlace, $scope.when, $scope.time, $scope.date].join('/'));
                };
            },
            scheduleController: function ($scope) {  
                //TODO: write this controller
            }
        });
        </script>
    </body>
    </html>
    <!--TODO: make sure all loading indicators show up and disappear correctly. -->
    <!--TODO: Android Browser and IE, you are my mortal enemies. -->