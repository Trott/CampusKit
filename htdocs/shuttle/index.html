<!-- 
    TODO: router, including handling form parameters
    TODO: factory, service, or provider, perhaps with $http object, for XHR calls 
    TODO: Angular 1.1.4 or later has ng-animate
    TODO: style menu with gaps around items
    TODO: move controller code to its own file, duh
-->
<!DOCTYPE html>
<html data-ng-app="shuttle">
<head>
    <meta charset="utf-8">
    <title>UCSF Mobile | Shuttle</title>
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" media="screen">
    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" href="/assets/css/ie.css" media="screen">
        <![endif]-->
        <link rel="stylesheet" type="text/css" href="/assets/css/secondary.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/assets/css/shuttle.css" media="screen">
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">

        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png">
    </head>
    <body>
        <header class="header"><a href="/"><div class="logo"></div><span>Mobile</span></a><img src="/assets/img/ucsf-header-separator.png" alt=" | " class="separator"><span><a href="/shuttle">Shuttle</a></span></header>
        <div class="menu detailed">
            <ol>
                <li data-ng-controller="planController">
                    <a data-ng-click="show=!show" data-ng-init="show=false" href="">Trip Planner</a>
                    <div data-ng-show="show">
                        <p data-ng-show="stopsLoadError">Content could not be loaded. Please try again later.</p>
                        <div data-ng-show="!stopsLoaded && !stopsLoadError"><progress><span class="spinner"></span></progress></div>
                        <form data-ng-show="stopsLoaded" action="/shuttle/planner/">
                            <select data-ng-model="begin" data-ng-options="stop.stopName for stop in stops" name="begin">
                            </select>
                            <button type="button" class="reverse_trip">&uarr;&darr;</button>
                            <select data-ng-model="end" data-ng-options="stop.stopName for stop in stops" name="end">
                            </select>
                            <fieldset name="datetime">
                                <legend>
                                    <select data-ng-model="when" class="compact" name="when">
                                        <option value="now">Leave now</option>
                                        <option value="depart">Depart at</option>
                                        <option value="arrive">Arrive by</option>
                                    </select>
                                </legend>
                                <select data-ng-disabled="when=='now'" data-ng-model="time" class="compact" name="time">
                                    <option value="6:00am">6:00am</option>
                                    <option value="6:15am">6:15am</option>
                                    <option value="6:30am">6:30am</option>
                                    <option value="6:45am">6:45am</option>
                                    <option value="7:00am">7:00am</option>
                                    <option value="7:15am">7:15am</option>
                                    <option value="7:30am">7:30am</option>
                                    <option value="7:45am">7:45am</option>
                                    <option value="8:00am">8:00am</option>
                                    <option value="8:15am">8:15am</option>
                                    <option value="8:30am">8:30am</option>
                                    <option value="8:45am">8:45am</option>
                                    <option value="9:00am">9:00am</option>
                                    <option value="9:15am">9:15am</option>
                                    <option value="9:30am">9:30am</option>
                                    <option value="9:45am">9:45am</option>
                                    <option value="10:00am">10:00am</option>
                                    <option value="10:15am">10:15am</option>
                                    <option value="10:30am">10:30am</option>
                                    <option value="10:45am">10:45am</option>
                                    <option value="11:00am">11:00am</option>
                                    <option value="11:15am">11:15am</option>
                                    <option value="11:30am">11:30am</option>
                                    <option value="11:45am">11:45am</option>
                                    <option value="12:00pm">12:00pm</option>
                                    <option value="12:15pm">12:15pm</option>
                                    <option value="12:30pm">12:30pm</option>
                                    <option value="12:45pm">12:45pm</option>
                                    <option value="1:00pm">1:00pm</option>
                                    <option value="1:15pm">1:15pm</option>
                                    <option value="1:30pm">1:30pm</option>
                                    <option value="1:45pm">1:45pm</option>
                                    <option value="2:00pm">2:00pm</option>
                                    <option value="2:15pm">2:15pm</option>
                                    <option value="2:30pm">2:30pm</option>
                                    <option value="2:45pm">2:45pm</option>
                                    <option value="3:00pm">3:00pm</option>
                                    <option value="3:15pm">3:15pm</option>
                                    <option value="3:30pm">3:30pm</option>
                                    <option value="3:45pm">3:45pm</option>
                                    <option value="4:00pm">4:00pm</option>
                                    <option value="4:15pm">4:15pm</option>
                                    <option value="4:30pm">4:30pm</option>
                                    <option value="4:45pm">4:45pm</option>
                                    <option value="5:00pm">5:00pm</option>
                                    <option value="5:15pm">5:15pm</option>
                                    <option value="5:30pm">5:30pm</option>
                                    <option value="5:45pm">5:45pm</option>
                                    <option value="6:00pm">6:00pm</option>
                                    <option value="6:15pm">6:15pm</option>
                                    <option value="6:30pm">6:30pm</option>
                                    <option value="6:45pm">6:45pm</option>
                                    <option value="7:00pm">7:00pm</option>
                                    <option value="7:15pm">7:15pm</option>
                                    <option value="7:30pm">7:30pm</option>
                                    <option value="7:45pm">7:45pm</option>
                                    <option value="8:00pm">8:00pm</option>
                                    <option value="8:15pm">8:15pm</option>
                                    <option value="8:30pm">8:30pm</option>
                                    <option value="8:45pm">8:45pm</option>
                                    <option value="9:00pm">9:00pm</option>
                                </select>
                                <select data-ng-disabled="when=='now'" class="compact" name="date">
                                    <option value="0">Today</option>
                                    <option value="1">Tomorrow</option>
                                    <option value="2">In 2 days</option>
                                    <option value="3">In 3 days</option>
                                </select>
                            </fieldset>
                            <input type="submit" name="route" value="Route Trip" />
                        </form>
                    </div>
                </li>
                <li data-ng-controller="scheduleController">
                    <a href="" data-ng-click="show=!show">Shuttles By Route</a>
                    <div data-ng-show="show">Route!</div>
                </li>
                <li data-ng-controller="scheduleController">
                    <a href="" data-ng-click="show=!show">Shuttles By Location</a>
                    <div data-ng-show="show">Location!</div>
                </li>
            </ol>
        </div>
        <footer><p>University of California &copy; 2010-12 UC Regents<br><a href="/about">About</a> | <a href="/feedback/">Feedback</a></p></footer>
        <script src="/assets/js/ucsf.js"></script>
        <script src="/assets/js/angular.js"></script>
        <!--    <script src="/assets/js/shuttle.js"></script> -->
        <script>
        angular.module('shuttle', []).controller(
        {
            planController: function ($scope, $filter, $http) {
                var now = Date.now(),
                    minutes = Math.floor(parseInt($filter('date')(now, 'mm'), 10) / 15) * 15;
                if (minutes == 0) {
                    minutes = "00";
                }
                $scope.time = $filter('lowercase')($filter('date')(now, 'h:' + minutes + 'a'));
                $scope.when = 'now';

                $scope.stopsLoadError = false;
                $scope.stopsLoaded = false;

                var xhr = $http({
                    method: 'GET', 
                    url: 'http://apis.ucsf.edu/shuttle/stops',
                    params: {apikey: 'c631ef46e918c82cf81ef4869f0029d4'}
                });
                
                xhr.success(function (data) {
                    if (data.stops) {
                        $scope.stops = $filter('orderBy')(data.stops, 'stopName');

                        $scope.begin = $filter('filter')($scope.stops, 
                            function (elem) {
                                return elem.stopName == 'Parnassus Campus';
                            }
                        )[0];
                        $scope.end = $filter('filter')($scope.stops, 
                            function (elem) {
                                return elem.stopName == 'Mission Bay Campus';
                            }
                        )[0];
                        if (Modernizr.localstorage) {
                            if (localStorage.shuttle_start) {
                                $scope.begin = $scope.stops[localStorage.shuttle_start];
                            } 
                            if (localStorage.shuttle_end) {
                                $scope.end = $scope.stops[localStorage.shuttle_end];
                            }
                        }
                        $scope.stopsLoaded = true;
                    } else {
                        $scope.stopsLoadError = true;
                    }
                });

                xhr.error(function () {
                    $scope.stopsLoadError = true;
                })
            },
            scheduleController: function ($scope) {  }
        }
        );
        </script>
    </body>
    </html>